---
- name: Create application group
  ansible.builtin.group:
    name: "{{ vps_app_group }}"
    state: present
  tags: users

- name: Create application user
  ansible.builtin.user:
    name: "{{ vps_app_user }}"
    group: "{{ vps_app_group }}"
    groups: sudo
    append: true
    shell: "{{ vps_app_user_shell }}"
    home: "{{ vps_app_user_home }}"
    create_home: true
    state: present
  tags: users

- name: Create .ssh directory for application user
  ansible.builtin.file:
    path: "{{ vps_app_user_home }}/.ssh"
    state: directory
    owner: "{{ vps_app_user }}"
    group: "{{ vps_app_group }}"
    mode: '0700'
  tags: users

- name: Check if authorized_keys already exists
  ansible.builtin.stat:
    path: "{{ vps_app_user_home }}/.ssh/authorized_keys"
  register: authorized_keys_file
  tags: users

- name: Prompt for SSH public key if not provided
  ansible.builtin.pause:
    prompt: |

      ================================================================================
      SSH PUBLIC KEY REQUIRED
      ================================================================================
      Password authentication will be disabled after this playbook runs.

      Please paste your SSH PUBLIC key (starts with 'ssh-rsa', 'ssh-ed25519', etc.):
  register: ssh_key_prompt
  when:
    - vps_prompt_for_ssh_key | bool
    - vps_app_user_ssh_public_key | length == 0
    - not authorized_keys_file.stat.exists
  tags: users

- name: Set SSH public key from prompt
  ansible.builtin.set_fact:
    vps_app_user_ssh_public_key: "{{ ssh_key_prompt.user_input | trim }}"
  when:
    - ssh_key_prompt is defined
    - ssh_key_prompt.user_input is defined
    - ssh_key_prompt.user_input | trim | length > 0
  tags: users

- name: Validate SSH key is provided before continuing
  ansible.builtin.fail:
    msg: |
      No SSH public key provided!
      You must provide an SSH public key via:
        - vps_app_user_ssh_public_key variable, OR
        - Interactive prompt during playbook run

      Without an SSH key, you will be locked out of the server!
  when:
    - vps_app_user_ssh_public_key | length == 0
    - not authorized_keys_file.stat.exists
  tags: users

- name: Add SSH public key for application user
  ansible.posix.authorized_key:
    user: "{{ vps_app_user }}"
    key: "{{ vps_app_user_ssh_public_key }}"
    state: present
    exclusive: false
  when: vps_app_user_ssh_public_key | length > 0
  tags: users

- name: Ensure correct permissions on authorized_keys
  ansible.builtin.file:
    path: "{{ vps_app_user_home }}/.ssh/authorized_keys"
    owner: "{{ vps_app_user }}"
    group: "{{ vps_app_group }}"
    mode: '0600'
  when: vps_app_user_ssh_public_key | length > 0
  tags: users

- name: Verify SSH key was written correctly
  ansible.builtin.command:
    cmd: "grep -c 'ssh-' {{ vps_app_user_home }}/.ssh/authorized_keys"
  register: ssh_key_check
  changed_when: false
  failed_when: ssh_key_check.rc != 0 or ssh_key_check.stdout | int < 1
  when: vps_app_user_ssh_public_key | length > 0
  tags: users

- name: Set up passwordless sudo for application user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ vps_app_user }}
    line: '{{ vps_app_user }} ALL=(ALL) NOPASSWD:ALL'
    create: true
    validate: 'visudo -cf %s'
    mode: '0440'
  tags: users
