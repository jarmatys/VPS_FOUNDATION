---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - mssql_sa_password is defined
      - mssql_sa_password | length >= 8
    fail_msg: "Required variable: mssql_sa_password (min 8 characters with complexity requirements)"
  when: mssql_enabled | bool

- name: Create MSSQL data directory
  ansible.builtin.file:
    path: "{{ mssql_data_dir }}"
    state: directory
    owner: '10001'
    group: '0'
    mode: '0755'
  when: mssql_enabled | bool
  tags: mssql

- name: Build network list
  ansible.builtin.set_fact:
    mssql_networks: "{{ [{'name': mssql_network}] + (mssql_extra_networks | map('community.general.dict_kw', name='name') | list) }}"
  tags: mssql

- name: Start MSSQL container
  community.docker.docker_container:
    name: "{{ mssql_container_name }}"
    image: "{{ mssql_image }}"
    hostname: "{{ mssql_container_name }}"
    state: started
    recreate: true
    restart_policy: "{{ mssql_restart_policy }}"
    env: "{{ {'ACCEPT_EULA': 'Y', 'SA_PASSWORD': mssql_sa_password} | combine(mssql_extra_env) }}"
    volumes:
      - "{{ mssql_data_dir }}:/var/opt/mssql/data"
    networks: "{{ mssql_networks }}"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "{{ mssql_sa_password }}", "-C", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    comparisons:
      healthcheck: strict
    memory: "{{ mssql_memory_limit | default(omit, true) }}"
    memory_reservation: "{{ mssql_memory_reservation | default(omit, true) }}"
    cpus: "{{ mssql_cpus | default(omit, true) }}"
  when: mssql_enabled | bool
  tags: mssql

- name: Wait for MSSQL to be ready
  community.docker.docker_container_info:
    name: "{{ mssql_container_name }}"
  register: mssql_info
  until: mssql_info.container.State.Health.Status | default('starting') == "healthy"
  retries: 30
  delay: 5
  when: mssql_enabled
  tags: mssql

- name: Configure SQL Server max memory
  community.docker.docker_container_exec:
    container: "{{ mssql_container_name }}"
    command: >
      /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P '{{ mssql_sa_password }}' -C -Q
      "EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
       EXEC sp_configure 'max server memory', {{ mssql_max_server_memory_mb }}; RECONFIGURE;"
  when:
    - mssql_enabled | bool
    - mssql_max_server_memory_mb | default('', true) | string | length > 0
  tags: mssql
