---
- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_users + docker_additional_users }}"
  tags: docker

- name: Verify user can run Docker commands
  ansible.builtin.command: sg docker -c "docker ps"
  become: true
  become_user: "{{ item }}"
  register: docker_user_test
  changed_when: false
  loop: "{{ docker_users + docker_additional_users }}"
  tags: docker

- name: Display Docker user test result
  ansible.builtin.debug:
    msg: "User '{{ item.item }}' can successfully run Docker commands"
  loop: "{{ docker_user_test.results }}"
  when: item.rc == 0
  tags: docker
